% == PACKAGES USED == %


\RequirePackage{amsmath}
\RequirePackage{witharrows}

\RequirePackage{etoolbox}
\RequirePackage{simplekv}

\RequirePackage{longtable}


% == DEFINITIONS == %

%    * Texts used

\newcommand\textexplainmiddleID{Réf.}
\newcommand\textexplainmiddlehyp{Je sais que...}
\newcommand\textexplainmiddleprop{Propriété ou fait utilisé}
\newcommand\textexplainmiddlecons{Conséquence}

\newcommand\textexplainuniversityhyps{Démonstration sous les hypothèses}
\newcommand\textexplainuniversityhyp{Démonstration sous l'hypothèse}
\newcommand\textexplainuniversityccl{Conclusion}


%    * Common tools

\newcommand\explref{\@ifstar{\@explref@star}{\@explref@no@star}}

\newcommand\@explref@star[1]{%
    \framebox[1.5em]{#1}%
}

\newcommand\@explref@no@star[1]{%
    \@explref@star{\ref{#1}}%
}

\newcommand\demostep{}


%    * University version 

\newcounter{@demo@explain@id}


\newcommand\@expl@id[1]{%
    \framebox[1.5em]{\the@demo@explain@id}%
    \if\relax\detokenize{#1}\relax\else%
        \addtocounter{@demo@explain@id}{-1}%
        \refstepcounter{@demo@explain@id}\label{#1}
    \fi
    \stepcounter{@demo@explain@id}%
}


\newbool{@start@demo@explain@} 


\newcommand\@demostep@no@star[1][]{%
    \ifbool{@start@demo@explain@}{%
        \global\boolfalse{@start@demo@explain@}%
    }{%
        \\
    }%
    \@expl@id{#1}
    &
}


\setKVdefault[@demo@explain@keys]{%
    start = 1,
    hyps  = {},
    hyp   = {},
    ccl   = {}
}


\newenvironment{demoexplain}[1][]{
	\renewcommand\demostep\@demostep@no@star
    \useKVdefault[@demo@explain@keys]
    \setKV[@demo@explain@keys]{#1}
    %
    \ifthenelse{\equal{\useKV[@demo@explain@keys]{start}}{last}}{
    % If no environment has been used before !
        \ifnum\value{@demo@explain@id}<1
            \setcounter{@demo@explain@id}{1}
        \fi
    }{%
        \setcounter{@demo@explain@id}{\useKV[@demo@explain@keys]{start}}%
    }%
    \def\hyps{\useKV[@demo@explain@keys]{hyps}}
    \def\hyp{\useKV[@demo@explain@keys]{hyp}}
    \edef\ccl{\useKV[@demo@explain@keys]{ccl}}
    %
    \if\relax\hyps\relax\else%
        \if\relax\hyp\relax\else%
            \PackageError{lymath}{hyps and hyp are both used}%
                                 {use either hyps or hyp, or none of them}
        \fi
    \fi
    %
    \if\relax\hyps\relax\else%
        \underline{\textexplainuniversityhyps\vphantom{p\textexplainuniversityccl}} : \hyps
		\vspace{-.25em}
	\fi
    \if\relax\hyp\relax\else%
        \underline{\textexplainuniversityhyp\vphantom{p\textexplainuniversityccl}} : \hyp
		\vspace{-.25em}
    \fi
    \booltrue{@start@demo@explain@}
    \begin{longtable}{lll}
}{
    \end{longtable}
    \if\relax\ccl\relax\else%
		\vspace{-.25em}
        \underline{\textexplainuniversityccl\vphantom{\textexplainuniversityhyps}} : \ccl
    \fi
}


%    * Middle school version

\newbool{@start@demo@explain@star@}

\newcounter{@demo@explain@star@id}


\newcommand\@demo@extra[1]{%
	{\footnotesize#1}%
}


\newcommand\@expl@star@id[1]{%
    \the@demo@explain@star@id%
    \if\relax\detokenize{#1}\relax\else%
        \addtocounter{@demo@explain@star@id}{-1}%
        \refstepcounter{@demo@explain@star@id}\label{#1}
    \fi
    \stepcounter{@demo@explain@star@id}%
}


\newcommand\@demostep@star[1][]{%
	\ifbool{@start@demo@explain@star@}{%
		\global\boolfalse{@start@demo@explain@star@}%
	}{%
	    \\
	    \hline%
	}%
    \@expl@star@id{#1}%
    &
}


\setKVdefault[@demo@explain@star@keys]{%
    start = 1
}


\newenvironment{demoexplain*}[1][]{
	\renewcommand\demostep\@demostep@star
    \useKVdefault[@demo@explain@star@keys]
    \setKV[@demo@explain@star@keys]{#1}
    %
    \ifthenelse{\equal{\useKV[@demo@explain@star@keys]{start}}{last}}{
    % If no environment has been used before !
        \ifnum\value{@demo@explain@star@id}<1
            \setcounter{@demo@explain@star@id}{1}
        \fi
    }{%
        \setcounter{@demo@explain@star@id}{\useKV[@demo@explain@star@keys]{start}}%
    }%
    \booltrue{@start@demo@explain@star@}
    \small
    \renewcommand{\arraystretch}{1.5}
    \begin{longtable}{c|p{0.29\linewidth}|p{0.29\linewidth}|p{0.29\linewidth}}
    	\textbf{\@demo@extra{\textexplainmiddleID}}
			& \textbf{\@demo@extra{\textexplainmiddlehyp}}
	        & \textbf{\@demo@extra{\textexplainmiddleprop}}
	        & \textbf{\@demo@extra{\textexplainmiddlecons}}
	    \\ \hline
	    \endfirsthead
	    
    	\textbf{\@demo@extra{\textexplainmiddleID}}
			& \textbf{\@demo@extra{\textexplainmiddlehyp}}
	        & \textbf{\@demo@extra{\textexplainmiddleprop}}
	        & \textbf{\@demo@extra{\textexplainmiddlecons}}
	    \\ \hline
	    \endhead

		\multicolumn{4}{r}{{\textit{\@demo@extra{La suite page suivante...}}}}
		\\
		\endfoot

		\endlastfoot
}{
    \end{longtable}
    \renewcommand{\arraystretch}{1}
}
