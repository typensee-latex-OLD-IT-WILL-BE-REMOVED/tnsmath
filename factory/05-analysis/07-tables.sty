% == PACKAGES USED == %

\RequirePackage{commado}
\RequirePackage{xstring}

\RequirePackage{circledsteps}

\RequirePackage{tkz-tab}
\usetikzlibrary{calc}
\usetikzlibrary{babel} % IMPORTANT !
\usetikzlibrary{arrows.meta}


% == DEFINITIONS == %

% Better style for arrowhead !

\tkzTabSetup[arrowstyle = triangle 60]


% Graph Sign to decorate tkzTables.
%
% Source
%    + https://tex.stackexchange.com/a/549546/6880
%    + https://groups.google.com/forum/#!topic/fr.comp.text.tex/X6aIq-SZDFA

\newcounter{@tkz@tab@nbline}

\newcommand\@tkzdeco@node@middle[1]{
    \coordinate (M) at ($(T2#1)!.5!(T2\the\numexpr#1+1\relax)$)
}

% Comment a line
%
%    #1 : color
%    #2 : nb of the line
%    #3 : text
\newcommand\comLine[3][blue]{
    \@tkzdeco@node@middle{#2};
    \path
        (M.east) +(.6,0) node[right, #1]{\footnotesize#3}
    ;
}


% Options : @gso@ = @graph@sign@option
\newcounter{@gso@nb@functions}
\newcommand\@gso@function{}

\newcounter{@gso@nb@a@constraints}
\newcommand\@gso@a@constraints{}

\newcounter{@gso@nb@d@constraints}
\newcommand\@gso@d@constraints{}


\newcommand\@validate@graph@sign@option[1]{%
    % Parameter a
    \IfSubStr{an,ap}{#1}{%
        \stepcounter{@gso@nb@a@constraints}%
        \renewcommand\@gso@a@constraints{@#1}%
    }{%
    % Parameter d
        \IfSubStr{dn,dp,dz}{#1}{%
            \stepcounter{@gso@nb@d@constraints}%
            \renewcommand\@gso@d@constraints{@#1}%
        }{%
    % Functions with parameters
            \IfEqCase{#1}{%
                {ax+b}{%
                    \renewcommand\@gso@function{line}%
                }%
                {ax2+bx+c}{%
                    \renewcommand\@gso@function{parabola}%
                }%
            }[%
                \PackageError{lymath}{unknown option for graphSign}%
                                     {Illegal option given for graphSign : #1 .}%
            ]%
            \stepcounter{@gso@nb@functions}%
        }% END OF ELSE for parameter d 
    }% END OF ELSE for parameter a 
}


%    #1 : color
%    #2 : nb of the line
%    #3 : kind of graph
\newcommand\graphSign[3][blue]{%
    \renewcommand\@gso@function{}
    \renewcommand\@gso@a@constraints{}
    \renewcommand\@gso@d@constraints{}
    % Processing the options
    \setcounter{@gso@nb@functions}{0}
    \setcounter{@gso@nb@a@constraints}{0}
    \setcounter{@gso@nb@d@constraints}{0}
    %
    \DoWithCSL\@validate@graph@sign@option{#3}
    % Only one kind of function ?
    \ifnum\value{@gso@nb@functions}=1\else%
        \PackageError{lymath}{only one kind of function can be given graphSign}%
                             {Number of kinds of function given to graphSign = \the@gso@nb@functions. This is illegal !}%
    \fi%
    % Line need only one constraint for a.
    \IfStrEq{\@gso@function}{line}{%
        \ifnum\value{@gso@nb@d@constraints}=0\else%
            \PackageError{lymath}{constraints for d with lines are nonsense for graphSign}%
                                 {Lines for graphSign need only one constraint for a.}%
        \fi%
        %
        \ifnum\value{@gso@nb@a@constraints}=1\else%
            \PackageError{lymath}{one constraint for a with lines is needed for graphSign}%
                                 {Number of constraints for a given to graphSign = \the@gso@nb@a@constraints. This is illegal !}%
        \fi%
    }{%
    % Parabola need only one constraint for a and also one for d.
        \IfStrEq{\@gso@function}{parabola}{%
            \ifnum\value{@gso@nb@d@constraints}=1\else%
                \PackageError{lymath}{one constraint for d with parabolas is needed for graphSign}%
                                     {Number of constraints for d given to graphSign = \the@gso@nb@a@constraints. This is illegal !}%
            \fi%
            %
            \ifnum\value{@gso@nb@a@constraints}=1\else%
                \PackageError{lymath}{one constraint for a with lines is needed for graphSign}%
                                     {Number of constraints for a given to graphSign = \the@gso@nb@a@constraints. This is illegal !}%
            \fi%
        %
        }{}%
    }%
    % Call of the good function
    \csname    @sign@\@gso@function\@gso@a@constraints\@gso@d@constraints\endcsname{#1}{#2}
    % Looking for invalid options 
    % Everything is ok.
}


% LINES
%
% ax+b , ap  -->  \@sign@line@ap
% ax+b , an  -->  \@sign@line@an


% Abstraction for the lines
%
%    #1 : color
%    #2 : nb of the line
%    #3 : the root
%    #4 : 1st ordinate
%    #5 : 2nd ordinate
%    #6 : 1st sign
%    #7 : 2nd sign
%    #8 : 1st shifts
%    #9 : 2nd shifts
\newcommand\@abtrasct@sign@line[9]{
    \@tkzdeco@node@middle{#2};
    \path
        (M.east) +(.75,0) pic[right]{%
            code = {
            	% Axe of abscisses
                \draw[->, -Latex, #1] (-0.1,0)--+(0:2.7);
                % Plot of the function with the signs.
                \draw[#1]
                    (0, #4)   node[xshift = -1.5mm, yshift =#8]
                             {\CircledText{\scriptsize#6}}
                    --
                    (2.5, #5) node[xshift = -4.5mm, yshift = #9]
                             {\CircledText{\scriptsize#7}};
                % 1 root
                \path (1.25,0) node[above, #1]{\footnotesize#3};
        }
    };
}


%    #1 : color
%    #2 : nb of the line
%    #3 : the root
\newcommand\@sign@line@an[3]{
    \@abtrasct@sign@line{#1}{#2}{#3}  %
                        {.65} {-.65}  % 1st and 2nd ordinates
                        {$+$} {$-$}   % 1st and 2nd signs
                        {-4mm}{3.5mm} % 1st and 2nd y shifts
}

%    #1 : color
%    #2 : nb of the line
%    #3 : the root
\newcommand\@sign@line@ap[3]{
    \@abtrasct@sign@line{#1}{#2}{#3}   %
                        {-.65}{.65}    % 1st and 2nd ordinates
                        {$-$} {$+$}    % 1st and 2nd signs
                        {4mm} {-3.5mm} % 1st and 2nd y shifts
}


% PARABOLAS

% ax2+bx+c , ap , dp  -->  \@sign@parabola@ap@dp
% ax2+bx+c , ap , dn  -->  \@sign@parabola@ap@dn
% ax2+bx+c , ap , dz  -->  \@sign@parabola@ap@dz
% ...etc


% a > 0 and delta > 0
%
%    #1 : color
%    #2 : nb of the line
%    #3 : smaller root
%    #4 : bigger root
\newcommand\@sign@parabola@ap@dp[4]{
    \@tkzdeco@node@middle{#2};
    \path
        (M.east) +(.75,0) pic[right]{%
            code = {
                % Axe of abscisses
                \draw[->, -Latex, #1] (-0.1,0)--+(0:2.7);
                % Plot of the function.
                \draw[#1] (0.25,.6) parabola bend (1.25,-.6) (2.25,.6);
                % The signs.
                \path (.4,.3)     node[left, #1]
                                   {\CircledText{\scriptsize$+$}};
                \path (1.25,0.03) node[below, #1]
                                   {\CircledText{\scriptsize$-$}};
                \path (2.1,.3)    node[right, #1]
                                   {\CircledText{\scriptsize$+$}};
                % 2 roots
                \path (.32,0)  node[below, #1]
                               {\footnotesize#3};
                \path (2.18,0) node[below, #1]
                               {\footnotesize#4};
        	}
    	};
}


% a < 0 and delta > 0
%
%    #1 : color
%    #2 : nb of the line
%    #3 : smaller root
%    #4 : bigger root
\newcommand\@sign@parabola@an@dp[4]{
    \@tkzdeco@node@middle{#2};
    \path
        (M.east) +(.75,0) pic[right]{%
            code = {
                % Axe of abscisses
                \draw[->, -Latex, #1] (-0.1,0)--+(0:2.7);
                % Plot of the function.
                \draw[#1] (0.25,-.6) parabola bend (1.25,.6) (2.25,-.6);
                % The signs.
                \path (.4,-.3)     node[left, #1]
                                   {\CircledText{\scriptsize$-$}};
                \path (1.25,-0.03) node[above, #1]
                                   {\CircledText{\scriptsize$+$}};
                \path (2.1,-.3)    node[right, #1]
                                   {\CircledText{\scriptsize$-$}};
                % 2 roots
                \path (.32,0)  node[above, #1]
                               {\footnotesize#3};
                \path (2.18,0) node[above, #1]
                               {\footnotesize#4};
        	}
    	};
}


% Abstraction for the parabolas with delta = 0
%
%    #1 : color
%    #2 : nb of the line
%    #3 : the root
%    #4 : y shift
%    #5 : 1st ordinate
%    #6 : 2nd ordinate
%    #7 : sign
%    #8 : position
\newcommand\@abtrasct@sign@parabola@dz[8]{
    \@tkzdeco@node@middle{#2};
    \path
        (M.east) +(.75,0) pic[right]{%
            code = {
                % Axe of abscisses
                \draw[->, -Latex, #1] (-0.1,#6)--+(0:2.7);
                % Plot of the function.
                \draw[#1] (0.25,#5) parabola bend (1.25,#6) (2.25,#5);
                % The signs.
                \path (.5,#8) node[left, #1]
                              {\CircledText{\scriptsize#7}};
                \path (2,#8)  node[right, #1]
                              {\CircledText{\scriptsize#7}};
                % 1 root
                \path (1.25,#6) node[yshift = #4, #1]
                                {\footnotesize#3};
        	}
    	};
}


% a > 0 and delta = 0
%
%    #1 : color
%    #2 : nb of the line
%    #3 : root
\newcommand\@sign@parabola@ap@dz[3]{
	\@abtrasct@sign@parabola@dz{#1}{#2}         %
                               {#3}{0mm, above} % The root and its y shift
                               {.6}{-.6}        % 1st and 2nd ordinates
                               {$+$}{-.3}       % The sign and its position
}


% a < 0 and delta = 0
%
%    #1 : color
%    #2 : nb of the line
%    #3 : root
\newcommand\@sign@parabola@an@dz[3]{
	\@abtrasct@sign@parabola@dz{#1}{#2}           %
                               {#3}{-.1mm, below} % The root and its y shift
                               {-.6}{.6}          % 1st and 2nd ordinates
                               {$-$}{.3}          % The sign and its position
}


% Abstraction for the parabolas with delta < 0
%
%    #1 : color
%    #2 : nb of the line
%    #3 : y of the axe
%    #4 : 1st ordinate
%    #5 : 2nd ordinate
%    #6 : sign
%    #7 : ordinate
%    #8 : position
\newcommand\@abtrasct@sign@parabola@dn[8]{
    \@tkzdeco@node@middle{#2};
    \path
        (M.east) +(.75,0) pic[right]{%
            code = {
                % Axe of abscisses
                \draw[->, -Latex, #1] (-0.1,#3)--+(0:2.7);
                % Plot of the function.
                \draw[#1] (0.35,#4) parabola bend (1.25,#5) (2.15,#4);
                % The sign.
                \path (1.25,#7) node[#8, #1]
                              {\CircledText{\scriptsize#6}};
        	}
    	};
}


% a > 0 and delta < 0
%
%    #1 : color
%    #2 : nb of the line
\newcommand\@sign@parabola@ap@dn[2]{
	\@abtrasct@sign@parabola@dn{#1}{#2}          %
                               {-.55}            % y of the axe
                               {.57}{-.4}        % 1st and 2nd ordinates
                               {$+$}{.3}{below} % The sign, its ordinate and its position
}



\newcommand\@sign@parabola@an@dn[2]{
	\@abtrasct@sign@parabola@dn{#1}{#2}           %
                               {.55}              % y of the axe
                               {-.57}{.4}         % 1st and 2nd ordinates
                               {$-$}{-.3}{above} % The sign, its ordinate and its position
}

